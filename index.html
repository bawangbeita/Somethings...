<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Stardust - Elite Interaction</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #video-input { position: fixed; bottom: 20px; right: 20px; width: 120px; border-radius: 8px; border: 1px solid rgba(255, 215, 0, 0.3); transform: scaleX(-1); z-index: 10; opacity: 0.5; }
        #ui { position: fixed; top: 30px; left: 30px; color: #d4af37; font-family: 'Optima', 'Segoe UI', serif; z-index: 100; pointer-events: none; letter-spacing: 3px; }
        #loader { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 1000; color: #fff; font-family: sans-serif; font-weight: 100; }
    </style>
</head>
<body>

    <div id="loader">COLLECTING STARDUST...</div>
    <div id="ui">
        <div style="font-size: 24px; margin-bottom: 5px;">STELLAR CORE</div>
        <div id="status" style="font-size: 10px; color: #888;">INITIALIZING AI...</div>
    </div>
    <video id="video-input" autoplay playsinline></video>
    <div id="container"></div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.11.4/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        let scene, camera, renderer, particles = [];
        const COUNT = 1200; // 增加微细粒子数量以提升密度感

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 45;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('container').appendChild(renderer.domElement);

            // 创建细腻的光晕纹理
            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
            grad.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
            grad.addColorStop(0.2, 'rgba(212, 175, 55, 0.4)');
            grad.addColorStop(1, 'rgba(0, 0, 0, 0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, 32, 32);
            const glowTexture = new THREE.CanvasTexture(canvas);

            const masterGroup = new THREE.Group();
            scene.add(masterGroup);
            window.masterGroup = masterGroup;

            // 粒子材质
            const coreMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const glowMat = new THREE.SpriteMaterial({ 
                map: glowTexture, 
                blending: THREE.AdditiveBlending,
                transparent: true,
                opacity: 0.8
            });

            for (let i = 0; i < COUNT; i++) {
                const group = new THREE.Group();
                
                // 1. 极其微小的实心核 (针尖感)
                const core = new THREE.Mesh(new THREE.SphereGeometry(0.04, 6, 6), coreMat);
                
                // 2. 细腻光晕
                const glow = new THREE.Sprite(glowMat.clone());
                const glowScale = 0.2 + Math.random() * 0.4; // 随机光晕大小
                glow.scale.set(glowScale, glowScale, 1);
                glow.material.opacity = 0.3 + Math.random() * 0.5;

                group.add(core);
                group.add(glow);

                // 分布算法 (带留白的分布)
                const phi = Math.random() * Math.PI * 2;
                const theta = Math.acos(Math.random() * 2 - 1);
                
                // 聚集状态 (极小的核心)
                const r1 = 5 * Math.pow(Math.random(), 3); 
                group.userData.p1 = new THREE.Vector3(
                    r1 * Math.sin(theta) * Math.cos(phi),
                    r1 * Math.sin(theta) * Math.sin(phi),
                    r1 * Math.cos(theta)
                );
                
                // 散开状态 (大范围但精致)
                const r2 = 12 + Math.random() * 8;
                group.userData.p2 = new THREE.Vector3(
                    r2 * Math.sin(theta) * Math.cos(phi),
                    r2 * Math.sin(theta) * Math.sin(phi),
                    r2 * Math.cos(theta)
                );

                group.position.copy(group.userData.p1);
                masterGroup.add(group);
                particles.push(group);
            }

            initAI();
            animate();
            document.getElementById('loader').style.display = 'none';
        }

        async function initAI() {
            const video = document.getElementById('video-input');
            const hands = new Hands({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7 });
            
            hands.onResults(results => {
                const status = document.getElementById('status');
                if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) return;
                
                const lm = results.multiHandLandmarks[0];
                const isOpen = Math.hypot(lm[8].x - lm[0].x, lm[8].y - lm[0].y) > 0.4;
                
                status.innerText = isOpen ? "MODE: EXPANSION" : "MODE: SINGULARITY";

                // 高级感平滑跟随
                gsap.to(window.masterGroup.rotation, {
                    y: (lm[0].x - 0.5) * 3,
                    x: (lm[0].y - 0.5) * 3,
                    duration: 1.2,
                    ease: "power2.out"
                });

                toggleParticles(isOpen);
            });

            new Camera(video, { onFrame: async () => await hands.send({image: video}), width: 640, height: 480 }).start();
        }

        let isOpened = false;
        function toggleParticles(open) {
            if (isOpened === open) return;
            isOpened = open;

            particles.forEach((p, i) => {
                const target = open ? p.userData.p2 : p.userData.p1;
                gsap.to(p.position, {
                    x: target.x, y: target.y, z: target.z,
                    duration: 2, // 更加缓慢平稳的过渡
                    ease: open ? "expo.out" : "power3.inOut",
                    delay: Math.random() * 0.3 // 增加时间差，产生粒子云的流动感
                });
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            window.masterGroup.rotation.y += 0.001; // 极慢自转
            
            // 随机闪烁逻辑
            particles.forEach((p, i) => {
                if(i % 10 === 0) {
                    const glow = p.children[1];
                    glow.material.opacity = 0.3 + Math.sin(Date.now() * 0.002 + i) * 0.3;
                }
            });
            
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        init();
    </script>
</body>
</html>
